# 粒子検出・サイズ測定アプリ
このアプリは、粒子径の検出、重なり粒子の自動除外、粒子サイズの測定を行うStreamlitアプリケーションです。  
画像から粒子を自動検出し、重なりを検知した粒子を除外。CSVファイルへの保存と粒径分布の可視化も可能です。

## **機能概要**

1. **粒子検出**  
   - Hough Circle Transformで円形粒子を検出。
   - 検出した粒子の座標、半径を取得。

2. **重なり粒子の除外**  
   - 粒子間の重なりを自動判定。
   - 上にある粒子を計測対象に、下にある粒子を除外。

3. **スケールバー検出**  
   - スケールバーを自動検出し、実寸に変換。

4. **結果の可視化**  
   - 計測対象の粒子は緑、除外粒子は赤で表示。
   - 粒子サイズ分布のヒストグラムを描画。

5. **CSVファイルへの保存**  
   - 粒径計測結果をCSV形式で保存可能。

---

## **使用方法**

### 1. 環境のセットアップ

以下のコマンドで必要なライブラリをインストールしてください。

```bash
pip install streamlit opencv-python-headless numpy pillow matplotlib seaborn
```

### 2. アプリの起動
以下のコマンドでStreamlitアプリを起動します。
```bash
streamlit run app.py
```

### 3. 画像のアップロードと処理
1. アプリ上で画像（JPG/PNG形式）を複数アップロードします。
2. 粒子検出後、除外する粒子を選択できます。
3. 結果をCSVファイルに保存可能です。

### 4. 粒径データの可視化（CSVアップロード）
1. 計測結果のCSVファイルをアップロードします。
2. 粒径分布のヒストグラムを生成。
3. 平均値、標準偏差、変動係数（CV）を自動計算します。

### 主要関数の説明
#### `detect_circles(image)`
画像から粒子を検出する関数。Hough Circle Transformを用いて円形粒子を検出します。

#### `check_overlap(circles)`
粒子間の重なりを判定し、重なっている下の粒子を除外対象とする関数。

#### `draw_circles(image, circles, excluded_indices)`
検出した粒子を画像に描画する関数。除外粒子は赤、計測対象粒子は緑で表示されます。

#### `process_image(image)`
粒子検出、重なり判定、スケールバー検出を行い、計測対象粒子を選別する関数。

### 出力例
#### CSVファイル構造
```csv
Image,Particle Index,Diameter (pixels)
sample1.jpg,0,15.23
sample1.jpg,1,22.45
...
```

### 粒子検出結果
* 緑の円：計測対象粒子
- 赤の円：除外された粒子
+ 粒子サイズ分布のヒストグラム
* 横軸: 粒子サイズ（nm）
- 縦軸: 密度

### 注意事項
* 粒子の重なり判定は、粒子のy座標を基準に、上に位置する粒子を優先的に計測対象とします。
- スケールバーを検出する代わりに、標準PS粒子の計測データを用います。倍率などが異なる場合は、別途、手動でスケール係数を設定してください。

### ライセンス
このプロジェクトは MITライセンス に基づいて提供されています。
